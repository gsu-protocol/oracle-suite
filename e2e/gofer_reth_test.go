package e2e

import (
	"context"
	"testing"
	"time"

	"github.com/chronicleprotocol/infestor"
	"github.com/chronicleprotocol/infestor/origin"
	"github.com/chronicleprotocol/infestor/smocker"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func Test_Gofer_RETH(t *testing.T) {
	ctx, ctxCancel := context.WithTimeout(context.Background(), 2*time.Minute)
	defer ctxCancel()

	s := smocker.NewAPI("http://127.0.0.1:8081")
	require.NoError(t, s.Reset(ctx))

	err := infestor.NewMocksBuilder().
		Add(origin.NewExchange("balancerV2").
			WithCustom("match", "32296969ef14eb0c6d29669c550d4a044913023").
			WithCustom("response", "0000000000000000000000000000000000000000000000000000000000f1af6200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000ddef0116e5787f700000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000dec19bf143c0aed00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000e795da792fcbf670000000000000000000000000000000000000000000000000000000000002a3000000000000000000000000000000000000000000000000000000000635a7a9f")).
		Add(origin.NewExchange("rocketpool").WithSymbol("RETH/ETH").
			WithCustom("price", "0x0000000000000000000000000000000000000000000000000e795da792fcbf67")).
		Add(origin.NewExchange("curve").
			WithCustom("match", "dc24316b9ae028f1497c275eb9192a3ea0f67022").
			WithCustom("response", "0000000000000000000000000000000000000000000000000000000000f1b00b000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000ddddcd3e0dcac4e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000d4b16fbcb0c3c92")).
		Add(origin.NewExchange("wsteth").WithSymbol("WSTETH/ETH").WithPrice(1)).
		Add(origin.NewExchange("ethrpc")).
		Deploy(*s)
	require.NoError(t, err)

	mocks := []*smocker.Mock{
		smocker.NewMockBuilder().
			AddResponseHeader("Content-Type", "application/json").
			SetRequestBodyString(smocker.ShouldContainSubstring("eth_chainId")).
			SetResponseBody(mustReadFile("./testdata/mock/eth_chainId.json")).
			Mock(),
	}
	require.NoError(t, s.AddMocks(ctx, mocks))

	out, err := execCommand(ctx, "..", nil, "./gofer", "-c", "./e2e/testdata/config/gofer.hcl", "-v", "debug", "--norpc", "price", "RETH/ETH")
	require.NoError(t, err)

	p, err := parseGoferPrice(out)
	require.NoError(t, err)

	assert.Equal(t, "aggregator", p.Type)
	assert.Equal(t, float64(1.0429677630199397), p.Price)
	assert.Greater(t, len(p.Prices), 0)
}

func Test_Gofer_RETH_PriceRecurse(t *testing.T) {
	ctx, ctxCancel := context.WithTimeout(context.Background(), 2*time.Minute)
	defer ctxCancel()

	s := smocker.NewAPI("http://127.0.0.1:8081")
	require.NoError(t, s.Reset(ctx))

	err := infestor.NewMocksBuilder().
		Add(origin.NewExchange("rocketpool").WithSymbol("RETH/ETH").
			WithCustom("price", "0x0000000000000000000000000000000000000000000000000e795da792fcbf67")).
		Add(origin.NewExchange("balancerV2").
			WithCustom("match", "32296969ef14eb0c6d29669c550d4a044913023").
			WithCustom("response", "0000000000000000000000000000000000000000000000000000000000f1af6200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000ddef0116e5787f700000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000dec19bf143c0aed00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000e795da792fcbf670000000000000000000000000000000000000000000000000000000000002a3000000000000000000000000000000000000000000000000000000000635a7a9f")).
		Add(origin.NewExchange("curve").
			WithCustom("match", "dc24316b9ae028f1497c275eb9192a3ea0f67022").
			WithCustom("response", "0000000000000000000000000000000000000000000000000000000000f1b00b000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000ddddcd3e0dcac4e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000d4b16fbcb0c3c92")).
		Add(origin.NewExchange("wsteth").WithSymbol("WSTETH/ETH").WithPrice(1)).
		Add(origin.NewExchange("bitstamp").WithSymbol("ETH/USD").WithPrice(1)).
		Add(origin.NewExchange("coinbase").WithSymbol("ETH/USD").WithPrice(1)).
		Add(origin.NewExchange("gemini").WithSymbol("ETH/USD").WithPrice(1)).
		Add(origin.NewExchange("kraken").WithSymbol("ETH/USD").WithPrice(1)).
		Add(origin.NewExchange("binance").WithSymbol("ETH/BTC").WithPrice(1)).
		Add(origin.NewExchange("binance_us").WithSymbol("BTC/USD").WithPrice(1)).
		Add(origin.NewExchange("bitstamp").WithSymbol("BTC/USD").WithPrice(1)).
		Add(origin.NewExchange("coinbase").WithSymbol("BTC/USD").WithPrice(1)).
		Add(origin.NewExchange("gemini").WithSymbol("BTC/USD").WithPrice(1)).
		Add(origin.NewExchange("kraken").WithSymbol("BTC/USD").WithPrice(1)).
		Add(origin.NewExchange("ethrpc")).
		Deploy(*s)
	require.NoError(t, err)

	mocks := []*smocker.Mock{
		smocker.NewMockBuilder().
			AddResponseHeader("Content-Type", "application/json").
			SetRequestBodyString(smocker.ShouldContainSubstring("eth_chainId")).
			SetResponseBody(mustReadFile("./testdata/mock/eth_chainId.json")).
			Mock(),
	}
	require.NoError(t, s.AddMocks(ctx, mocks))

	out, err := execCommand(ctx, "..", nil, "./gofer", "-c", "./e2e/testdata/config/gofer.hcl", "-v", "debug", "--norpc", "price", "RETH/ETH")
	require.NoError(t, err)

	p, err := parseGoferPrice(out)
	require.NoError(t, err)

	assert.Equal(t, "aggregator", p.Type)
	assert.Equal(t, float64(1.0429677630199397), p.Price)
	assert.Greater(t, len(p.Prices), 0)
}

func Test_Gofer_RETH_Circuit(t *testing.T) {
	ctx, ctxCancel := context.WithTimeout(context.Background(), 2*time.Minute)
	defer ctxCancel()

	s := smocker.NewAPI("http://127.0.0.1:8081")
	require.NoError(t, s.Reset(ctx))

	err := infestor.NewMocksBuilder().
		Add(origin.NewExchange("rocketpool").WithSymbol("RETH/ETH").
			WithCustom("price", "0x0000000000000000000000000000000000000000000000001b7314242fae3395")). // 1.97
		Add(origin.NewExchange("balancerV2").WithSymbol("RETH/WETH").
			WithCustom("match", "01e19cf2d73a72ef1332c882f20534b6519be0276").
			WithCustom("response", "0000000000000000000000000000000000000000000000000000000000f1ae1900000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000dec19bf143c0aed00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000e795da792fcbf670000000000000000000000000000000000000000000000000000000000002a3000000000000000000000000000000000000000000000000000000000635a7a9f00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000dde952b2b374c17")).
		Add(origin.NewExchange("wsteth").WithSymbol("WSTETH/STETH")).
		Add(origin.NewExchange("curve").WithSymbol("STETH/ETH").
			WithCustom("match", "dc24316b9ae028f1497c275eb9192a3ea0f67022").
			WithCustom("response", "0000000000000000000000000000000000000000000000000000000000f1ae2500000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000dde952b2b374c1700000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000dec19bf143c0aed00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000e795da792fcbf670000000000000000000000000000000000000000000000000000000000002a3000000000000000000000000000000000000000000000000000000000635a7a9f")).
		Add(origin.NewExchange("ethrpc")).
		Deploy(*s)
	require.NoError(t, err)

	mocks := []*smocker.Mock{
		smocker.NewMockBuilder().
			AddResponseHeader("Content-Type", "application/json").
			SetRequestBodyString(smocker.ShouldContainSubstring("eth_chainId")).
			SetResponseBody(mustReadFile("./testdata/mock/eth_chainId.json")).
			Mock(),
	}
	require.NoError(t, s.AddMocks(ctx, mocks))

	_, err = execCommand(ctx, "..", nil, "./gofer", "-c", "./e2e/testdata/config/gofer.hcl", "-v", "debug", "--norpc", "price", "RETH/ETH")
	require.Error(t, err)
}
